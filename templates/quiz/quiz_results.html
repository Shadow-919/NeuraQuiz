{% extends 'base.html' %}
{% load static %}

{% block title %}Quiz Results - {{ attempt.quiz.title }}{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Results Header -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="results-header card border-0 shadow-strong text-center">
                <div class="card-body p-5">
                    <div class="results-icon mb-4">
                        {% if attempt.score >= 80 %}
                            <i class="fas fa-trophy"></i>
                        {% elif attempt.score >= 60 %}
                            <i class="fas fa-medal"></i>
                        {% else %}
                            <i class="fas fa-certificate"></i>
                        {% endif %}
                    </div>
                    <h1 class="display-5 fw-bold mb-3">Quiz Completed! ðŸŽ‰</h1>
                    <h2 class="h4 text-muted mb-4">{{ attempt.quiz.title }}</h2>
                    
                    <div class="score-display">
                        <div class="score-circle mx-auto">
                            <span class="score-number">{{ attempt.score|floatformat:0 }}%</span>
                            <div class="score-label">Final Score</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Stats -->
    <div class="row g-4 mb-5">
        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #10B981 0%, #34D399 100%);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number">{{ attempt.correct_answers }}</h3>
                    <p class="stats-label">Correct</p>
                </div>
            </div>
        </div>
        
        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #EF4444 0%, #F87171 100%);">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number">{{ wrong_answers }}</h3>
                    <p class="stats-label">Wrong</p>
                </div>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #06B6D4 0%, #22D3EE 100%);">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number">{{ attempt.total_questions }}</h3>
                    <p class="stats-label">Total</p>
                </div>
            </div>
        </div>
        
        <div class="col-6 col-md-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number" style="font-size: 1.5rem;">{{ formatted_time|default:"N/A" }}</h3>
                    <p class="stats-label">Time</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Analysis -->
    <div class="row g-4 mb-5">
        <div class="col-lg-8">
            <div class="card border-0 shadow-md">
                <div class="card-header">
                    <h3 class="mb-0 fw-bold">
                        <i class="fas fa-chart-bar me-2"></i>Performance Analysis
                    </h3>
                </div>
                <div class="card-body p-4">
                    <div class="performance-metrics">
                        <div class="metric-item mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">Accuracy</span>
                                <span class="fw-bold">{{ attempt.score|floatformat:1 }}%</span>
                            </div>
                            <div class="progress" style="height: 12px;">
                                <div id="accuracy-bar" class="progress-bar {% if attempt.score >= 80 %}bg-success{% elif attempt.score >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                     role="progressbar">
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-item mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold">Speed</span>
                                <span class="text-muted">
                                    {% if avg_time_per_question %}
                                        {{ avg_time_per_question }}s per question
                                    {% else %}
                                        Not available
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <div class="metric-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold">Completion</span>
                                <span class="text-success fw-semibold">
                                    <i class="fas fa-check-circle me-1"></i>100% Complete
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card border-0 shadow-md">
                <div class="card-header">
                    <h3 class="mb-0 fw-bold">
                        <i class="fas fa-trophy me-2"></i>Achievement
                    </h3>
                </div>
                <div class="card-body p-4 text-center">
                    {% if attempt.score >= 90 %}
                        <div class="achievement">
                            <i class="fas fa-star" style="font-size: 4rem; color: #F59E0B;"></i>
                            <h4 class="mt-3 fw-bold">Excellent!</h4>
                            <p class="text-muted mb-0">Outstanding performance!</p>
                        </div>
                    {% elif attempt.score >= 80 %}
                        <div class="achievement">
                            <i class="fas fa-thumbs-up" style="font-size: 4rem; color: #10B981;"></i>
                            <h4 class="mt-3 fw-bold">Very Good!</h4>
                            <p class="text-muted mb-0">Great job!</p>
                        </div>
                    {% elif attempt.score >= 60 %}
                        <div class="achievement">
                            <i class="fas fa-check-circle" style="font-size: 4rem; color: #06B6D4;"></i>
                            <h4 class="mt-3 fw-bold">Good!</h4>
                            <p class="text-muted mb-0">Keep practicing!</p>
                        </div>
                    {% else %}
                        <div class="achievement">
                            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #F59E0B;"></i>
                            <h4 class="mt-3 fw-bold">Needs Improvement</h4>
                            <p class="text-muted mb-0">Review and try again!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights -->
    {% if insights %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-md">
                <div class="card-header">
                    <h3 class="mb-0 fw-bold">
                        <i class="fas fa-robot me-2"></i>AI Insights
                    </h3>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        {% for insight in insights %}
                        <div class="col-md-6">
                            <div class="insight-card">
                                <div class="insight-header">
                                    <i class="fas fa-{% if insight.insight_type == 'strength' %}thumbs-up{% elif insight.insight_type == 'weakness' %}exclamation-triangle{% elif insight.insight_type == 'recommendation' %}lightbulb{% else %}info-circle{% endif %} 
                                       text-{% if insight.insight_type == 'strength' %}success{% elif insight.insight_type == 'weakness' %}warning{% elif insight.insight_type == 'recommendation' %}info{% else %}primary{% endif %} me-2"></i>
                                    <span class="insight-type">{{ insight.insight_type|title }}</span>
                                    <span class="confidence-badge">{{ insight.confidence_score|floatformat:1 }}</span>
                                </div>
                                <p class="insight-content">{{ insight.content }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Detailed Question Review -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-md">
                <div class="card-header">
                    <h3 class="mb-0 fw-bold">
                        <i class="fas fa-list-ol me-2"></i>Question Review
                    </h3>
                </div>
                <div class="card-body p-4">
                    {% for item in detailed_results %}
                    <div class="review-item card border mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-2">{{ item.number }}. {{ item.text }}</h6>
                                    <small class="text-muted">Type: {{ item.type|title }}</small>
                                </div>
                                <div>
                                    {% if item.status == 'correct' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Correct
                                        </span>
                                    {% elif item.status == 'wrong' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times me-1"></i>Wrong
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">Unattempted</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-2">
                                <strong class="text-muted small">Your answer:</strong>
                                <div class="ms-3">
                                    {% if item.student_answer %}
                                        {{ item.student_answer }}
                                    {% else %}
                                        <em class="text-muted">No answer</em>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-2">
                                <strong class="text-muted small">Correct answer:</strong>
                                <div class="ms-3 text-success fw-semibold">{{ item.correct_answer }}</div>
                            </div>

                            {% if item.explanation %}
                            <div class="mt-3 p-3 bg-light rounded">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    <strong>Explanation:</strong> {{ item.explanation }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row">
        <div class="col-12 text-center">
            <div class="action-buttons d-flex flex-wrap gap-3 justify-content-center">
                <a href="{% url 'quiz:dashboard' %}" class="btn btn-primary btn-lg px-5">
                    <i class="fas fa-tachometer-alt me-2"></i>Back to Dashboard
                </a>
                <a href="{% url 'quiz:take_quiz' attempt.quiz.id %}" class="btn btn-outline-primary btn-lg px-5">
                    <i class="fas fa-redo me-2"></i>Retake Quiz
                </a>
                <button class="btn btn-outline-success btn-lg px-5" onclick="shareResults()">
                    <i class="fas fa-share me-2"></i>Share Results
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.results-header {
    animation: fadeInUp 0.8s ease-out;
}

.results-icon i {
    font-size: 5rem;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}

.score-circle {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    box-shadow: 0 20px 40px rgba(79, 70, 229, 0.3);
}

.score-number {
    font-size: 3.5rem;
    font-weight: 800;
    line-height: 1;
}

.score-label {
    font-size: 1rem;
    opacity: 0.9;
    margin-top: 0.5rem;
    font-weight: 600;
}

.performance-metrics {
    animation: fadeInUp 0.6s ease-out 0.2s backwards;
}

.achievement {
    animation: fadeInUp 0.6s ease-out 0.3s backwards;
}

.insight-card {
    background: var(--gray-50);
    border-radius: 12px;
    padding: 1.25rem;
    border-left: 4px solid var(--primary-color);
    transition: all 0.3s ease;
}

.insight-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.insight-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
}

.insight-type {
    font-weight: 700;
    color: var(--gray-900);
    flex-grow: 1;
}

.confidence-badge {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
}

.insight-content {
    color: var(--gray-700);
    line-height: 1.6;
    margin: 0;
}

.review-item {
    animation: fadeInUp 0.4s ease-out backwards;
}

.review-item:nth-child(n) {
    animation-delay: calc(0.05s * var(--i, 1));
}

@media (max-width: 768px) {
    .score-circle {
        width: 160px;
        height: 160px;
    }
    
    .score-number {
        font-size: 2.5rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: 'Quiz Results - {{ attempt.quiz.title }}',
            text: `I scored {{ attempt.score|floatformat:1 }}% on {{ attempt.quiz.title }}!`,
            url: window.location.href
        });
    } else {
        const text = `I scored {{ attempt.score|floatformat:1 }}% on {{ attempt.quiz.title }}! Check out NeuraQuiz for more quizzes.`;
        navigator.clipboard.writeText(text).then(() => {
            alert('Results copied to clipboard!');
        });
    }
}

// Set dynamic accuracy bar width
document.addEventListener('DOMContentLoaded', function() {
    try {
        var bar = document.getElementById('accuracy-bar');
        if (bar) {
            var score = parseFloat('{{ attempt.score|default:0 }}') || 0;
            bar.style.width = score + '%';
        }
    } catch (e) {
        console.error('Failed to set accuracy bar width', e);
    }
    
    // Add staggered animation to review items
    const reviewItems = document.querySelectorAll('.review-item');
    reviewItems.forEach((item, index) => {
        item.style.setProperty('--i', index + 1);
    });
});
</script>
{% endblock %}